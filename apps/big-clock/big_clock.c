#include <furi.h>
#include <furi_hal.h>
#include <gui/gui.h>
#include <input/input.h>
#include <notification/notification.h>
#include <notification/notification_messages.h>
#include <stdio.h>

#define DIGIT_WIDTH 24
#define DIGIT_HEIGHT 48
#define COLON_WIDTH 8
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

typedef struct {
    uint8_t hour;
    uint8_t minute;
    uint8_t brightness;  // 0-100
    uint8_t show_brightness_timer;  // Countdown to hide brightness indicator
    bool running;
} BigClockState;

// Large digit bitmaps (24x48 pixels each)
// Each digit is defined as an array of bytes, 3 bytes per row (24 bits), 48 rows
static const uint8_t digit_0[] = {
    0x07, 0xFF, 0xE0, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC, 0x7F, 0xFF, 0xFE,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F,
    0x7E, 0x00, 0x7E, 0x7F, 0xFF, 0xFE, 0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8,
    0x07, 0xFF, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_1[] = {
    0x00, 0x1F, 0x00, 0x00, 0x3F, 0x00, 0x00, 0xFF, 0x00, 0x03, 0xFF, 0x00,
    0x0F, 0xFF, 0x00, 0x1F, 0xFF, 0x00, 0x1F, 0x1F, 0x00, 0x1C, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00,
    0x00, 0x1F, 0x00, 0x0F, 0xFF, 0xF0, 0x0F, 0xFF, 0xF0, 0x0F, 0xFF, 0xF0,
    0x0F, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_2[] = {
    0x07, 0xFF, 0xE0, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC, 0x7F, 0xFF, 0xFE,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x3F, 0x00, 0x00, 0x7E, 0x00, 0x00, 0xFC, 0x00, 0x01, 0xF8,
    0x00, 0x03, 0xF0, 0x00, 0x07, 0xE0, 0x00, 0x0F, 0xC0, 0x00, 0x1F, 0x80,
    0x00, 0x3F, 0x00, 0x00, 0x7E, 0x00, 0x00, 0xFC, 0x00, 0x01, 0xF8, 0x00,
    0x03, 0xF0, 0x00, 0x07, 0xE0, 0x00, 0x0F, 0xC0, 0x00, 0x1F, 0x80, 0x00,
    0x3F, 0x00, 0x00, 0x7E, 0x00, 0x00, 0xFC, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xFC, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_3[] = {
    0x07, 0xFF, 0xE0, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC, 0x7F, 0xFF, 0xFE,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x7E,
    0x00, 0x00, 0xFC, 0x00, 0xFF, 0xF8, 0x00, 0xFF, 0xF0, 0x00, 0xFF, 0xF8,
    0x00, 0x00, 0xFC, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7E, 0x7F, 0xFF, 0xFE,
    0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8, 0x07, 0xFF, 0xE0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_4[] = {
    0x00, 0x01, 0xF8, 0x00, 0x03, 0xF8, 0x00, 0x07, 0xF8, 0x00, 0x0F, 0xF8,
    0x00, 0x1F, 0xF8, 0x00, 0x3E, 0xF8, 0x00, 0x7C, 0xF8, 0x00, 0xF8, 0xF8,
    0x01, 0xF0, 0xF8, 0x03, 0xE0, 0xF8, 0x07, 0xC0, 0xF8, 0x0F, 0x80, 0xF8,
    0x1F, 0x00, 0xF8, 0x3E, 0x00, 0xF8, 0x7C, 0x00, 0xF8, 0xF8, 0x00, 0xF8,
    0xF8, 0x00, 0xF8, 0xF8, 0x00, 0xF8, 0xF8, 0x00, 0xF8, 0xF8, 0x00, 0xF8,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8,
    0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8,
    0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8,
    0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8,
    0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_5[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xF8, 0xFF, 0xFF, 0xFC, 0x00, 0x00, 0xFE,
    0x00, 0x00, 0x7E, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7E, 0x7F, 0xFF, 0xFE,
    0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8, 0x07, 0xFF, 0xE0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_6[] = {
    0x07, 0xFF, 0xE0, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC, 0x7F, 0xFF, 0xFE,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00,
    0xF8, 0x00, 0x00, 0xF9, 0xFF, 0xE0, 0xFB, 0xFF, 0xF8, 0xFF, 0xFF, 0xFC,
    0xFF, 0xFF, 0xFE, 0xFE, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7E, 0x7F, 0xFF, 0xFE,
    0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8, 0x07, 0xFF, 0xE0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_7[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x3E,
    0x00, 0x00, 0x7E, 0x00, 0x00, 0x7C, 0x00, 0x00, 0xFC, 0x00, 0x00, 0xF8,
    0x00, 0x01, 0xF8, 0x00, 0x01, 0xF0, 0x00, 0x03, 0xF0, 0x00, 0x03, 0xE0,
    0x00, 0x07, 0xE0, 0x00, 0x07, 0xC0, 0x00, 0x0F, 0xC0, 0x00, 0x0F, 0x80,
    0x00, 0x1F, 0x80, 0x00, 0x1F, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x3E, 0x00,
    0x00, 0x7E, 0x00, 0x00, 0x7C, 0x00, 0x00, 0xFC, 0x00, 0x00, 0xF8, 0x00,
    0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00,
    0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00,
    0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00,
    0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00, 0x00, 0xF8, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_8[] = {
    0x07, 0xFF, 0xE0, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC, 0x7F, 0xFF, 0xFE,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7E,
    0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7E, 0x7F, 0xFF, 0xFE,
    0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8, 0x07, 0xFF, 0xE0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t digit_9[] = {
    0x07, 0xFF, 0xE0, 0x1F, 0xFF, 0xF8, 0x3F, 0xFF, 0xFC, 0x7F, 0xFF, 0xFE,
    0x7E, 0x00, 0x7E, 0xFC, 0x00, 0x3F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7F, 0x7F, 0xFF, 0xFF,
    0x3F, 0xFF, 0xFF, 0x1F, 0xFF, 0xDF, 0x07, 0xFF, 0x9F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F,
    0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0xF8, 0x00, 0x1F, 0xF8, 0x00, 0x1F,
    0xF8, 0x00, 0x1F, 0xFC, 0x00, 0x3F, 0x7E, 0x00, 0x7E, 0x7F, 0xFF, 0xFE,
    0x3F, 0xFF, 0xFC, 0x1F, 0xFF, 0xF8, 0x07, 0xFF, 0xE0, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const uint8_t* digits[] = {
    digit_0, digit_1, digit_2, digit_3, digit_4,
    digit_5, digit_6, digit_7, digit_8, digit_9
};

static void draw_digit(Canvas* canvas, uint8_t digit, int16_t x, int16_t y) {
    if(digit > 9) return;
    const uint8_t* bitmap = digits[digit];

    for(int row = 0; row < DIGIT_HEIGHT; row++) {
        for(int col = 0; col < DIGIT_WIDTH; col++) {
            int byte_idx = row * 3 + col / 8;
            int bit_idx = 7 - (col % 8);
            if(bitmap[byte_idx] & (1 << bit_idx)) {
                canvas_draw_dot(canvas, x + col, y + row);
            }
        }
    }
}

static void draw_colon(Canvas* canvas, int16_t x, int16_t y) {
    // Draw two dots for the colon, centered vertically
    int dot_size = 4;
    int top_y = y + 14;
    int bottom_y = y + 30;

    canvas_draw_box(canvas, x + 2, top_y, dot_size, dot_size);
    canvas_draw_box(canvas, x + 2, bottom_y, dot_size, dot_size);
}

static void render_callback(Canvas* canvas, void* ctx) {
    BigClockState* state = (BigClockState*)ctx;

    canvas_clear(canvas);

    // Calculate positions to center HH:MM
    // Total width: 4 digits (24 each) + 1 colon (8) = 104 pixels
    // Screen width: 128, so start at (128-104)/2 = 12
    int16_t start_x = 12;
    int16_t y = (SCREEN_HEIGHT - DIGIT_HEIGHT) / 2;  // Center vertically

    // Draw hours (tens)
    draw_digit(canvas, state->hour / 10, start_x, y);
    start_x += DIGIT_WIDTH;

    // Draw hours (ones)
    draw_digit(canvas, state->hour % 10, start_x, y);
    start_x += DIGIT_WIDTH;

    // Draw colon
    draw_colon(canvas, start_x, y);
    start_x += COLON_WIDTH;

    // Draw minutes (tens)
    draw_digit(canvas, state->minute / 10, start_x, y);
    start_x += DIGIT_WIDTH;

    // Draw minutes (ones)
    draw_digit(canvas, state->minute % 10, start_x, y);

    // Show brightness indicator when recently changed
    if(state->show_brightness_timer > 0) {
        // Draw brightness bar at bottom of screen
        canvas_set_font(canvas, FontSecondary);

        // Draw "Brightness: XX%" text
        char brightness_text[20];
        snprintf(brightness_text, sizeof(brightness_text), "Brightness: %d%%", state->brightness);
        canvas_draw_str_aligned(canvas, 64, 2, AlignCenter, AlignTop, brightness_text);

        // Draw brightness bar background
        canvas_draw_frame(canvas, 14, 56, 100, 6);
        // Draw filled portion
        uint8_t bar_width = state->brightness;
        if(bar_width > 0) {
            canvas_draw_box(canvas, 15, 57, bar_width - 1, 4);
        }
    }
}

static void input_callback(InputEvent* input_event, void* ctx) {
    FuriMessageQueue* event_queue = ctx;
    furi_message_queue_put(event_queue, input_event, FuriWaitForever);
}

// Pre-defined brightness levels (must be static to avoid stack issues)
static const NotificationMessage msg_backlight_10 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 25};
static const NotificationMessage msg_backlight_20 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 51};
static const NotificationMessage msg_backlight_30 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 76};
static const NotificationMessage msg_backlight_40 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 102};
static const NotificationMessage msg_backlight_50 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 127};
static const NotificationMessage msg_backlight_60 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 153};
static const NotificationMessage msg_backlight_70 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 178};
static const NotificationMessage msg_backlight_80 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 204};
static const NotificationMessage msg_backlight_90 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 229};
static const NotificationMessage msg_backlight_100 = {.type = NotificationMessageTypeLedDisplayBacklight, .data.led.value = 255};
static const NotificationMessage msg_do_not_reset = {.type = NotificationMessageTypeDoNotReset};

static const NotificationSequence seq_brightness_10 = {&msg_backlight_10, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_20 = {&msg_backlight_20, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_30 = {&msg_backlight_30, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_40 = {&msg_backlight_40, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_50 = {&msg_backlight_50, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_60 = {&msg_backlight_60, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_70 = {&msg_backlight_70, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_80 = {&msg_backlight_80, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_90 = {&msg_backlight_90, &msg_do_not_reset, NULL};
static const NotificationSequence seq_brightness_100 = {&msg_backlight_100, &msg_do_not_reset, NULL};

static const NotificationSequence* brightness_sequences[] = {
    &seq_brightness_10, &seq_brightness_20, &seq_brightness_30, &seq_brightness_40, &seq_brightness_50,
    &seq_brightness_60, &seq_brightness_70, &seq_brightness_80, &seq_brightness_90, &seq_brightness_100
};

static void set_backlight_brightness(NotificationApp* notification, uint8_t brightness) {
    // Clamp brightness to 10-100 range
    if(brightness > 100) brightness = 100;
    if(brightness < 10) brightness = 10;

    // Get index (0-9) for brightness level
    uint8_t index = (brightness / 10) - 1;
    if(index > 9) index = 9;

    notification_message(notification, brightness_sequences[index]);
}

int32_t big_clock_app(void* p) {
    UNUSED(p);

    // Allocate state
    BigClockState* state = malloc(sizeof(BigClockState));
    state->brightness = 100;
    state->show_brightness_timer = 0;
    state->running = true;

    // Create message queue for input events
    FuriMessageQueue* event_queue = furi_message_queue_alloc(8, sizeof(InputEvent));

    // Create viewport
    ViewPort* view_port = view_port_alloc();
    view_port_draw_callback_set(view_port, render_callback, state);
    view_port_input_callback_set(view_port, input_callback, event_queue);

    // Register viewport in GUI
    Gui* gui = furi_record_open(RECORD_GUI);
    gui_add_view_port(gui, view_port, GuiLayerFullscreen);

    // Open notification service
    NotificationApp* notification = furi_record_open(RECORD_NOTIFICATION);
    // Set initial brightness
    set_backlight_brightness(notification, state->brightness);

    InputEvent event;

    while(state->running) {
        // Get current time from RTC
        DateTime datetime;
        furi_hal_rtc_get_datetime(&datetime);
        state->hour = datetime.hour;
        state->minute = datetime.minute;

        // Decrement brightness display timer
        if(state->show_brightness_timer > 0) {
            state->show_brightness_timer--;
        }

        // Keep backlight alive at current brightness (prevents auto-off)
        set_backlight_brightness(notification, state->brightness);

        // Request screen update
        view_port_update(view_port);

        // Wait for input with timeout (update every second)
        if(furi_message_queue_get(event_queue, &event, 1000) == FuriStatusOk) {
            if(event.type == InputTypePress || event.type == InputTypeRepeat) {
                switch(event.key) {
                    case InputKeyUp:
                        // Increase brightness
                        if(state->brightness < 100) {
                            state->brightness += 10;
                            if(state->brightness > 100) state->brightness = 100;
                            set_backlight_brightness(notification, state->brightness);
                            state->show_brightness_timer = 3;  // Show for 3 seconds
                        }
                        break;
                    case InputKeyDown:
                        // Decrease brightness
                        if(state->brightness > 10) {
                            state->brightness -= 10;
                            set_backlight_brightness(notification, state->brightness);
                            state->show_brightness_timer = 3;  // Show for 3 seconds
                        }
                        break;
                    case InputKeyBack:
                        // Exit app
                        state->running = false;
                        break;
                    default:
                        break;
                }
            }
        }
    }

    // Cleanup - restore default backlight behavior
    notification_message(notification, &sequence_display_backlight_on);
    furi_record_close(RECORD_NOTIFICATION);

    gui_remove_view_port(gui, view_port);
    furi_record_close(RECORD_GUI);

    view_port_free(view_port);
    furi_message_queue_free(event_queue);
    free(state);

    return 0;
}
